# AXIUART COMポート通信ソフトウェア仕様書
**作成日**: 2025年10月4日  
**バージョン**: v1.0  
**対象システム**: PMOD準拠4線式UART with RTS/CTS

## 1. 概要

### 1.1 目的
FPGA上に実装されたAXIUARTシステムとPC間でのCOMポート経由通信を実現するソフトウェアの開発。AXI4-Liteレジスタアクセス、フロー制御検証、リアルタイムデータ転送に対応。

### 1.2 システム構成
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│    PC Host      │    │   USB-UART      │    │   FPGA Board    │
│                 │    │   Bridge        │    │                 │
│ ┌─────────────┐ │USB │ ┌──────────────┐ │UART│ ┌─────────────┐ │
│ │ COM Driver  │◄┼────┼►│ FT232/CP2102 │◄┼────┼►│ AXIUART_Top │ │
│ │ Software    │ │    │ │              │ │    │ │             │ │
│ └─────────────┘ │    │ └──────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └──────────────────┘    └─────────────────┘
```

### 1.3 対応プロトコル
- **UART設定**: 8N1, 115200bps (デフォルト), RTS/CTSフロー制御
- **フレーム形式**: UART-AXI4プロトコル v0.1準拠
- **エラー検出**: CRC-8 (多項式0x07)
- **アドレス空間**: 0x1000-0x1FFF (レジスタマップ)

## 2. 機能要件

### 2.1 基本機能

#### 2.1.1 COMポート管理
- **ポート検出**: 利用可能なCOMポートの自動スキャン
- **接続/切断**: 指定ポートへの接続/切断機能
- **設定変更**: ボーレート、フロー制御モードの動的変更
- **状態監視**: 接続状態、信号レベル(RTS/CTS/DSR/DTR)の表示

#### 2.1.2 プロトコル実装
- **フレーム送信**: SOF(0xA5) + CMD + ADDR + DATA + CRC構築
- **フレーム受信**: SOF(0x5A) + STATUS + DATA + CRC検証
- **コマンド生成**: 
  - READ: CMD[7]=1, SIZE指定, LEN指定
  - WRITE: CMD[7]=0, SIZE指定, LEN指定, データペイロード
- **エラーハンドリング**: CRC不一致、タイムアウト、ステータスエラー処理

#### 2.1.3 レジスタアクセス
- **個別レジスタ**: CONTROL, STATUS, CONFIG等の読み書き
- **バルクアクセス**: 連続アドレスの一括読み書き
- **レジスタマップ**: 0x1000ベースの32bitアライン済みアクセス
- **データ形式**: リトルエンディアン、8/16/32bit幅対応

### 2.2 フロー制御機能

#### 2.2.1 RTS/CTS制御
- **RTSアサート**: 受信可能状態の明示制御
- **CTS監視**: 送信許可状態の確認
- **フロー制御テスト**: 意図的なバックプレッシャー生成
- **タイミング測定**: RTS/CTS応答時間の計測

#### 2.2.2 FIFO状態監視
- **FIFO_STAT読み取り**: TX/RX FIFOの使用量監視
- **しきい値テスト**: RTS制御しきい値の動作確認
- **オーバーフロー検出**: FIFO満杯時の動作確認

### 2.3 診断・デバッグ機能

#### 2.3.1 パケット解析
- **送受信ログ**: 全フレームの16進ダンプ表示
- **CRC計算**: 送受信フレームのCRC検証状況
- **タイミング解析**: フレーム間隔、応答時間の測定
- **エラー統計**: CRCエラー、タイムアウト、プロトコルエラーのカウント

#### 2.3.2 テストパターン
- **レジスタテスト**: 全レジスタの読み書きテスト
- **データパターン**: 0x00, 0xFF, 0xAA, 0x55等のパターンテスト
- **ストレステスト**: 連続アクセス、ランダムアクセスの実行
- **フロー制御テスト**: RTS/CTS動作の自動検証

## 3. ユーザーインターフェース

### 3.1 GUI構成

#### 3.1.1 メインウィンドウ
```
┌─────────────────────────────────────────────────────────────┐
│ AXIUART COMポート通信ツール v1.0                           │
├─────────────────────────────────────────────────────────────┤
│ [接続設定]                                                  │
│ COMポート: [COM3 ▼] ボーレート: [115200 ▼] [接続] [切断]   │
│ フロー制御: [RTS/CTS ☑] DTR: [☑] RTS: [☑]                 │
├─────────────────────────────────────────────────────────────┤
│ [レジスタアクセス]                                          │
│ アドレス: [0x1000] 値: [0x00000001] [読み取り] [書き込み]   │
│ サイズ: ○8bit ●32bit ○バルク  長さ: [1]                   │
├─────────────────────────────────────────────────────────────┤
│ [ステータス表示]                                            │
│ CONTROL: 0x00000001  STATUS: 0x00000000  CONFIG: 0x00000000│
│ TX_COUNT: 123        RX_COUNT: 89        FIFO_STAT: 0x0000 │
├─────────────────────────────────────────────────────────────┤
│ [通信ログ]                                                  │
│ TX: A5 80 00 10 00 00 XX (CRC OK)                         │
│ RX: 5A 00 01 00 00 00 XX (CRC OK, 1.2ms)                  │
│ [ログクリア] [ログ保存] [自動更新 ☑]                      │
└─────────────────────────────────────────────────────────────┘
```

#### 3.1.2 詳細ウィンドウ
- **レジスタマップビュー**: 全レジスタの一覧表示・編集
- **フロー制御モニタ**: RTS/CTS信号の時系列グラフ
- **パケットアナライザ**: フレーム詳細解析表示
- **テスト実行ダイアログ**: 自動テストの設定・実行

### 3.2 コマンドライン対応
```bash
# 基本アクセス
axiuart_cli.exe --port COM3 --read 0x1000
axiuart_cli.exe --port COM3 --write 0x1000 0x00000001

# テスト実行
axiuart_cli.exe --port COM3 --test register
axiuart_cli.exe --port COM3 --test flowcontrol

# ログ出力
axiuart_cli.exe --port COM3 --monitor --log uart_log.txt
```

## 4. 技術仕様

### 4.1 開発環境
- **言語**: C# (.NET 6.0以降) / Python 3.9以降
- **UI框架**: WPF (C#) / tkinter + matplotlib (Python)
- **シリアル通信**: System.IO.Ports (C#) / pyserial (Python)
- **対象OS**: Windows 10/11, macOS, Linux

### 4.2 プロトコル実装詳細

#### 4.2.1 フレーム構造
```
送信フレーム (READ):
┌─────┬─────┬──────────────┬─────┐
│ SOF │ CMD │    ADDR      │ CRC │
│ A5  │ 8X  │ XX XX XX XX  │ XX  │
└─────┴─────┴──────────────┴─────┘

送信フレーム (WRITE):
┌─────┬─────┬──────────────┬──────────┬─────┐
│ SOF │ CMD │    ADDR      │   DATA   │ CRC │
│ A5  │ 0X  │ XX XX XX XX  │ XX XX..  │ XX  │
└─────┴─────┴──────────────┴──────────┴─────┘

受信フレーム:
┌─────┬────────┬──────────┬─────┐
│ SOF │ STATUS │   DATA   │ CRC │
│ 5A  │   XX   │ XX XX..  │ XX  │
└─────┴────────┴──────────┴─────┘
```

#### 4.2.2 CRC-8実装
```csharp
public static byte CalculateCRC8(byte[] data, int offset, int length)
{
    byte crc = 0x00;
    for (int i = offset; i < offset + length; i++)
    {
        crc ^= data[i];
        for (int j = 0; j < 8; j++)
        {
            if ((crc & 0x80) != 0)
                crc = (byte)((crc << 1) ^ 0x07);
            else
                crc <<= 1;
        }
    }
    return crc;
}
```

### 4.3 エラーハンドリング

#### 4.3.1 タイムアウト設定
- **フレーム応答**: 100ms (115200bps基準)
- **接続確立**: 2秒
- **リトライ回数**: 3回 (指数バックオフ)

#### 4.3.2 エラーコード
- `0x00`: SUCCESS - 正常完了
- `0x01`: CRC_ERR - CRCエラー
- `0x02`: TIMEOUT - タイムアウト
- `0x03`: INVALID_CMD - 不正コマンド
- `0x04`: AXI_ERROR - AXI4-Liteエラー
- `0x80`: STATUS_BUSY - ビジー状態

## 5. 実装フェーズ

### Phase 1: 基本通信 (Week 1)
- COMポート接続・切断
- 基本フレーム送受信
- CRC実装・検証
- 単一レジスタ読み書き

### Phase 2: レジスタアクセス (Week 2)  
- レジスタマップ実装
- バルクアクセス対応
- エラーハンドリング強化
- 基本GUI作成

### Phase 3: フロー制御 (Week 3)
- RTS/CTS制御実装
- フロー制御テスト機能
- リアルタイム監視
- パフォーマンス測定

### Phase 4: 高度機能 (Week 4)
- 自動テストスイート
- ログ解析機能
- CLI版実装
- ドキュメント整備

## 6. 品質保証

### 6.1 テスト要件
- **単体テスト**: プロトコル処理、CRC計算の検証
- **結合テスト**: 実FPGA環境での動作確認
- **性能テスト**: スループット、レイテンシ測定
- **ストレステスト**: 長時間連続動作の確認

### 6.2 検証項目
- [ ] 全レジスタアクセス正常性
- [ ] フロー制御動作確認
- [ ] エラー条件での robust性
- [ ] 異なるボーレートでの動作
- [ ] マルチプラットフォーム対応

この仕様書に基づいて、まずPhase 1の基本通信機能から実装を開始することを提案します。