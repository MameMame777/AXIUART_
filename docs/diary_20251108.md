# Development Diary — 2025-11-08

## Context

- Tasked with resolving UART loopback monitor mis-detection during UVM-only debug runs.
- Prior DSIM runs flagged `PARSE_ERROR_SOF_MISMATCH` (monitor sampled 0xB4 instead of expected 0x5A).

## Actions

- Updated `sim/uvm/agents/uart/uart_monitor.sv::collect_uart_tx_byte` to reuse `cfg.get_bit_time_cycles()` and `cfg.get_half_bit_cycles()`.
- Adjusted sampling schedule to advance one full bit period after the start-bit midpoint, aligning the first data sample with the center of bit[0].
- Confirmed loopback configuration remains isolated from full RTL tests.

## Verification

- `python mcp_server/mcp_client.py --workspace e:\Nautilus\workspace\fpgawork\AXIUART_ --tool run_uvm_simulation --test-name uart_axi4_uvm_loopback_test --mode run --verbosity UVM_MEDIUM --waves --timeout 300 --plusarg +UVM_LOOPBACK=1`
  - Result: PASS, monitor publishes TX frame `0x5A 0x00 0x00 0x00`, no parse errors or driver fallbacks.
  - Artifacts: `sim/exec/logs/uart_axi4_uvm_loopback_test_20251108_153912.log`, `archive/waveforms/uart_axi4_uvm_loopback_test_20251108_153912.mxd`.

## Notes

- No other UVM components required modification.
- Full-system test (`uart_axi4_basic_test`) remains unaffected and continues to pass.
- Ready for baud-rate variation tests; timing helpers now shared across driver, monitor, and loopback model.

## MCP Client Cleanup (2025-11-08 PM)

- Objective: streamline MCP client/batch scripts by centralising shared logic and removing direct imports of server internals.
- Created `mcp_server/client_api.py` with reusable helpers for launching FastMCP server sessions, invoking tools, and decoding results.
- Marked `mcp_server` as a package via `__init__.py` to enable relative imports.
- Refactored `mcp_server/mcp_client.py` to reuse the shared API, adding `--list-tools` support and consistent JSON printing.
- Updated `mcp_server/batch_compile_run.py` and `mcp_server/batch_test_runner.py` to call the shared helpers instead of spawning subprocesses or importing server modules directly.
- Command log: `git status -sb` (pre/post), no simulations executed for this cleanup.
- Next steps: validate updated scripts through a smoke run of `mcp_client.py --list-tools` once MCP server task is available in the workspace.

## MCP Artifact Cleanup (2025-11-08 Evening)

- Objective: remove generated MCP artifacts (`mcp_server/dsim.log`, `__pycache__/`) to keep the repository clean before rerunning diagnostics.
- Deleted the stale log file and Python bytecode caches under `mcp_server/` and `mcp_server/tools/`.
- Confirmed no additional legacy helpers remain beyond the FastMCP stack documented in `mcp_server/README.md`.
- Re-ran loopback smoke:
  - `python mcp_server/mcp_client.py --workspace e:\Nautilus\workspace\fpgawork\AXIUART_ --tool run_uvm_simulation --test-name uart_axi4_uvm_loopback_test --mode run --verbosity UVM_MEDIUM --waves --timeout 300 --plusarg +UVM_LOOPBACK=1`
  - Result: PASS, TX/RX monitoring clean (log: `sim/exec/logs/uart_axi4_uvm_loopback_test_20251108_165225.log`, waveform: `archive/waveforms/uart_axi4_uvm_loopback_test_20251108_165225.mxd`).

## RTL Cleanup (2025-11-08 Late)

- Purpose: ensure `rtl/` contains production design sources only and move verification-specific assertion modules into the UVM hierarchy.
- Actions: relocated Frame Parser and UART bridge timeout assertion/bind files to `sim/uvm/assertions/`, purged the originals from `rtl/`, and updated both `sim/uvm/dsim_config.f` and `sim/uvm/config/dsim_config.f` to pull from the new paths.
- Verification: no simulations executed; confirmed directory listings and filelist diffs reflect the new placement.
- Notes: assertion modules remain bind-driven and now align with the repository's separation guideline between RTL and verification assets.

## DSIM Regression Attempt (2025-11-08 Night)

- Command: `python mcp_server/mcp_client.py --workspace e:\Nautilus\workspace\fpgawork\AXIUART_ --tool run_uvm_simulation --test-name uart_axi4_basic_test --mode run --verbosity UVM_MEDIUM --waves --timeout 300`
- Result: FAIL — simulation halted at 35.684 µs with `UVM_FATAL` (`DEBUG_SEQ_TIMEOUT`) after UART driver fallback also failed to capture a response; emergency diagnostics flagged frame parser state 0 held >1600 cycles.
- Telemetry: warnings for TX monitor parse errors (`PARSE_ERROR_LENGTH`), scoreboard skipped response comparison, SVA summary reported one failure in `emergency_frame_parser_diagnostics`.
- Artifacts: waveform `archive/waveforms/uart_axi4_basic_test_20251108_191342.mxd` (auto-generated by DSIM); no textual log emitted under `sim/uvm/exec/logs/` for this run.
- Follow-up: analyze emergency diagnostic assertion and UART TX parse path before rerunning; license contention resolved automatically prior to this attempt.
