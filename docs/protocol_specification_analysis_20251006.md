# ðŸ“š Phase 2 å®Ÿè¡Œ: ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜å®Œå…¨æŠŠæ¡ãƒ¬ãƒãƒ¼ãƒˆ

**å®Ÿè¡Œæ—¥**: 2025å¹´10æœˆ6æ—¥  
**å¯¾è±¡**: AXIUART_ ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜ã¨è¨­è¨ˆæ–‡æ›¸ã®è©³ç´°è§£æž  
**ä½œæ¥­åŸºæº–**: protocol_alignment_work_instruction_20251006.md Phase 2

---

## ðŸ” 2.1 ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã®è©³ç´°è§£æžçµæžœ

### 2.1.1 ä»•æ§˜æ›¸ã§ã®å®šæ•°å®šç¾©ç¢ºèª

#### **é‡è¦ç™ºè¦‹**: ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã§æ˜Žç¢ºã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹æ­£å¼ãªå€¤

**File**: `docs/uart_axi4_protocol.md` (v0.1, 2025-09-15)

```markdown
### 2.1 Common fields

- SOF: 1 byte start-of-frame marker
  - Request (hostâ†’device): `0xA5`
  - Response (deviceâ†’host): `0x5A`    â† âœ… æ­£å¼ãªä»•æ§˜å€¤
  
- STATUS: 1 byte present only in response; `0x00` means OK  â† âœ… æ­£å¼ãªä»•æ§˜å€¤
```

#### **ãƒ•ãƒ¬ãƒ¼ãƒ æ§‹é€ ã®æ­£å¼å®šç¾©**

**Write response** (deviceâ†’host):
```
SOF (0x5A) | STATUS | CMD | CRC8
```

**Read response** (deviceâ†’host):
```
SOF (0x5A) | STATUS | CMD | ADDR[3:0] | DATA[...] | CRC8
```

#### **STATUS ã‚³ãƒ¼ãƒ‰ã®å®Œå…¨å®šç¾©**

```markdown
## 3. Status codes

- `0x00` OK: Success                    â† âœ… æ­£å¼ãªæˆåŠŸã‚³ãƒ¼ãƒ‰
- `0x01` CRC_ERR: CRC mismatch on received frame
- `0x02` CMD_INV: Unsupported/illegal `CMD`
- `0x03` ADDR_ALIGN: Address/size alignment error
- `0x04` TIMEOUT: AXI or internal timeout
- `0x05` AXI_SLVERR: AXI response SLVERR/DECERR
- `0x06` BUSY: Device busy/resource contention
- `0x07` LEN_RANGE: `LEN` exceeds supported maximum
- `0x08` PARAM: Other parameter error (reserved for future)
```

### 2.1.2 ãƒ—ãƒ­ãƒˆã‚³ãƒ«æ”¹è¨‚å±¥æ­´ã¨ä¸‹ä½äº’æ›æ€§

**æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v0.1 (2025-09-15)
**Owner**: Project UARTâ€“AXI4 Bridge
**æ”¹è¨‚å±¥æ­´**: åˆç‰ˆï¼ˆæ”¹è¨‚å±¥æ­´ã®è¨˜è¼‰ãªã—ï¼‰

---

## ðŸ“Š 2.2 è¨­è¨ˆæ–‡æ›¸ã¨ã®æ•´åˆæ€§ç¢ºèªçµæžœ

### 2.2.1 ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ç¢ºèª

**File**: `docs/design_overview.md`

**ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆ**:
```
UART RX/TX â†’ Protocol Processing â†’ AXI4-Lite Master
```

**é‡è¦ãªæ•´åˆæ€§ç¢ºèª**:
- UARTè¨­å®š: 8N1 format, 115200 baud âœ…
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«å‡¦ç†: Frame Parser/Builder âœ…
- CRC8æ¤œè¨¼: polynomial 0x07 âœ…

### 2.2.2 ãƒ¬ã‚¸ã‚¹ã‚¿ãƒžãƒƒãƒ—ã¨ã®æ•´åˆæ€§

**File**: `docs/register_map.md`

**ãƒ†ã‚¹ãƒˆãƒ¬ã‚¸ã‚¹ã‚¿å®šç¾©**:
```
| Offset | Name         | Address    |
|--------|--------------|------------|
| 0x020  | REG_TEST_0   | 0x00001020 |
| 0x024  | REG_TEST_1   | 0x00001024 |
| 0x028  | REG_TEST_2   | 0x00001028 |
| 0x02C  | REG_TEST_3   | 0x0000102C |
```

**CONTROL ãƒ¬ã‚¸ã‚¹ã‚¿å‹•ä½œ**:
- bridge_enable (bit 0): Bridgeå‹•ä½œåˆ¶å¾¡
- STATUS_BUSY (0x06) å¿œç­”ã§ã®ç«¶åˆçŠ¶æ…‹å‡¦ç†

---

## ðŸ”§ 2.3 å®Ÿè£…å±¥æ­´ã®èª¿æŸ»çµæžœ

### 2.3.1 ãƒ—ãƒ­ãƒˆã‚³ãƒ«é•åå•é¡Œã®çµŒç·¯

**File**: `docs/protocol_violation_diagnosis_20251006.md`

**ä»¥å‰ã®è¨ºæ–­çµæžœ** (èª¤è¨ºæ–­ã§ã‚ã‚‹ã“ã¨ãŒåˆ¤æ˜Ž):
```markdown
### 1. SOF (Start of Frame) é•å
- **æœŸå¾…å€¤**: `0x5A` (ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜)
- **å®Ÿéš›å€¤**: `0xAD`     â† ã“ã‚Œã¯éŽåŽ»ã®æ¸¬å®š
```

**æœ€æ–°ã®å•é¡Œèªè­˜** (Phase 1èª¿æŸ»çµæžœ):
- **ä»•æ§˜å€¤**: `0x5A` (ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã§ç¢ºå®š)
- **RTLå®Ÿè£…å€¤**: `0x6B` (0x5A ^ 0x31)
- **"æœŸå¾…å€¤" 0x2D**: **å‡ºå…¸ä¸æ˜Žã€æ ¹æ‹ ãªã—**

### 2.3.2 é–‹ç™ºçµŒç·¯ã®è§£æž

**File**: `docs/diary_20251006_phase4_completion.md`

**Phase 4ã§ã®ä¿®æ­£å†…å®¹**:
- CMD_ECHOå•é¡Œã®æ ¹æœ¬è§£æ±ºï¼ˆ0x20â†’0x48ï¼‰
- captured_cmd ãƒ¬ã‚¸ã‚¹ã‚¿è¿½åŠ ã«ã‚ˆã‚‹é©åˆ‡ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°å‡¦ç†
- ILAãƒ‡ãƒãƒƒã‚°ä¿¡å·ã®è¿½åŠ 

**é‡è¦**: SOF/STATUSå€¤ã®å¤‰æ›´å±¥æ­´ãªã—

---

## ðŸ§ª 2.4 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä»•æ§˜ã®ç¢ºèªçµæžœ

### 2.4.1 UVMãƒ†ã‚¹ãƒˆãƒ™ãƒ³ãƒä»•æ§˜

**File**: `docs/uvm_verification_plan.md`

**æ¤œè¨¼å¯¾è±¡**:
- CONTROL disable/enable ã‚·ãƒ¼ã‚±ãƒ³ã‚¹
- STATUS_BUSYå¿œç­”å‡¦ç†
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«æº–æ‹ æ€§ç¢ºèª

**æœŸå¾…å€¤è¨­å®š**: å…·ä½“çš„ãªSOF/STATUSæœŸå¾…å€¤ã®è¨˜è¼‰ãªã—

### 2.4.2 Pythonãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆä»•æ§˜

**File**: `software/test_registers_updated.py`

**ãƒ†ã‚¹ãƒˆå‹•ä½œ**:
```python
# STATUSåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
if status == 0x00:
    print("âœ… Status OK")
    return data_value
elif status == 0x80:
    print("âš ï¸  Status 0x80 - but data received, might be valid")
    return data_value  # Try accepting it
```

**é‡è¦**: 
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã® STATUS=0x00 ã‚’æœŸå¾…
- 0x2D, 0x6C ã®æœŸå¾…å€¤è¨­å®šã¯å­˜åœ¨ã—ãªã„

---

## ðŸŽ¯ Phase 2 é‡è¦ç™ºè¦‹ã®ã‚µãƒžãƒªãƒ¼

### ðŸ” "æœŸå¾…å€¤" 0x2D, 0x6C ã®å‡ºå…¸èª¿æŸ»çµæžœ

#### âŒ æ ¹æ‹ ã¨ãªã‚‹ä»•æ§˜æ›¸ãƒ»è¨­è¨ˆæ–‡æ›¸ãƒ»ãƒ†ã‚¹ãƒˆä»•æ§˜ãŒå­˜åœ¨ã—ãªã„

**èª¿æŸ»å¯¾è±¡**:
- âœ… ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ (`uart_axi4_protocol.md`)
- âœ… è¨­è¨ˆæ¦‚è¦æ›¸ (`design_overview.md`) 
- âœ… ãƒ¬ã‚¸ã‚¹ã‚¿ãƒžãƒƒãƒ— (`register_map.md`)
- âœ… UVMæ¤œè¨¼è¨ˆç”» (`uvm_verification_plan.md`)
- âœ… Pythonãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`test_registers_updated.py`)
- âœ… é–‹ç™ºå±¥æ­´ãƒ»ãƒ—ãƒ­ãƒˆã‚³ãƒ«é•åè¨ºæ–­æ–‡æ›¸

**æ¤œç´¢çµæžœ**: 0x2D, 0x6C ã®æœŸå¾…å€¤ã¯å…¨ã¦ `protocol_alignment_work_instruction_20251006.md` ä»¥é™ã®æŽ¨å®šå€¤ã®ã¿

### âœ… ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã§ã®æ­£å¼å®šç¾©

| Field | ä»•æ§˜æ›¸å®šç¾© | RTLå®Ÿè£…å€¤ | "æœŸå¾…å€¤"(æ ¹æ‹ ãªã—) | æ•´åˆæ€§ |
|-------|----------|----------|------------------|--------|
| SOF   | 0x5A | 0x6B (0x5A^0x31) | 0x2D | âŒ RTLãŒä»•æ§˜ã¨ä¸æ•´åˆ |
| STATUS| 0x00 | 0x60 (0x00^0x60) | 0x6C | âŒ RTLãŒä»•æ§˜ã¨ä¸æ•´åˆ |

### ðŸ”§ æ ¹æœ¬å•é¡Œã®ç‰¹å®š

**çœŸã®å•é¡Œ**: 
1. **RTLå®Ÿè£…ãŒãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã¨ä¸æ•´åˆ**
   - SOF: ä»•æ§˜ 0x5A vs å®Ÿè£… 0x6B
   - STATUS: ä»•æ§˜ 0x00 vs å®Ÿè£… 0x60

2. **ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ä¿®æ­£ãƒžã‚¹ã‚¯ãŒä¸é©åˆ‡**
   - ç¾åœ¨ã®ä¿®æ­£ãƒžã‚¹ã‚¯ã¯ä½•ã‚‰ã‹ã®çµŒé¨“çš„å¯¾å‡¦
   - ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã«åŸºã¥ã‹ãªã„ä¿®æ­£

3. **"æœŸå¾…å€¤" 0x2D, 0x6C ã¯å¹»å½±**
   - å®Ÿåœ¨ã—ãªã„æœŸå¾…å€¤ã«åŸºã¥ãå•é¡Œèªè­˜
   - çœŸã®å•é¡Œï¼ˆä»•æ§˜ vs å®Ÿè£…ï¼‰ã‚’éš è”½

---

## ðŸ“‹ Phase 3ã¸ã®æè¨€

### ðŸŽ¯ æ­£ã—ã„å•é¡Œè§£æ±ºã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

#### 1. RTLå®Ÿè£…ã‚’ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã«åˆã‚ã›ã‚‹ï¼ˆæŽ¨å¥¨ï¼‰
```systemverilog
// ä¿®æ­£æ¡ˆ1: ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ä¿®æ­£ãƒžã‚¹ã‚¯ã‚’ç„¡åŠ¹åŒ–
tx_fifo_data = SOF_DEVICE_TO_HOST;  // 0x5Aç›´æŽ¥é€ä¿¡
tx_fifo_data = status_reg;          // 0x00ç›´æŽ¥é€ä¿¡
```

#### 2. ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã‚’RTLå®Ÿè£…ã«åˆã‚ã›ã‚‹ï¼ˆä»£æ›¿æ¡ˆï¼‰
```markdown
# uart_axi4_protocol.md æ”¹è¨‚æ¡ˆ
- Response (deviceâ†’host): `0x6B`  // 0x5Aâ†’0x6Bå¤‰æ›´
- STATUS: `0x60` means OK          // 0x00â†’0x60å¤‰æ›´
```

#### 3. çµ±åˆãƒ†ã‚¹ãƒˆã‚’æ­£ã—ã„ä»•æ§˜ã§å®Ÿè¡Œ
- ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ (0x5A, 0x00) ã‚’åŸºæº–ã¨ã—ãŸæ¤œè¨¼
- å¹»å½±æœŸå¾…å€¤ (0x2D, 0x6C) ã®å®Œå…¨é™¤åŽ»

### ðŸ“… å³åŠ¹æ€§ã¨ãƒªã‚¹ã‚¯è©•ä¾¡

**å³åŠ¹æ€§**: RTLä¿®æ­£ > ä»•æ§˜å¤‰æ›´ > ãƒ†ã‚¹ãƒˆä¿®æ­£
**ãƒªã‚¹ã‚¯**: ä»•æ§˜å¤‰æ›´ < RTLä¿®æ­£ < ç¾çŠ¶ç¶­æŒ

**æŽ¨å¥¨**: Option 1 (RTLâ†’ä»•æ§˜åˆã‚ã›) ã§ãƒ—ãƒ­ãƒˆã‚³ãƒ«æ•´åˆæ€§ã‚’ç¢ºç«‹

---

## âœ… Phase 2 å®Œäº†åŸºæº–é”æˆ

- [x] ãƒ—ãƒ­ãƒˆã‚³ãƒ«ä»•æ§˜æ›¸ã®å®Œå…¨ç†è§£ã¨æ­£å¼å®šæ•°ç¢ºèª
- [x] è¨­è¨ˆæ–‡æ›¸ã¨ã®æ•´åˆæ€§ç¢ºèª 
- [x] å®Ÿè£…å±¥æ­´ã®è©³ç´°èª¿æŸ»
- [x] ãƒ†ã‚¹ãƒˆä»•æ§˜ã®å¦¥å½“æ€§æ¤œè¨¼
- [x] "æœŸå¾…å€¤"ã®å‡ºå…¸èª¿æŸ»ã¨æ ¹æ‹ ç¢ºèª

**SystemVerilogã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨ã—ã¦ã€è«–ç†çš„ã§ä½“ç³»çš„ãªä»•æ§˜è§£æžã«ã‚ˆã‚Š Phase 2ã‚’ç¢ºå®Ÿã«å®Œäº†ã—ã¾ã—ãŸã€‚** ðŸŽ¯