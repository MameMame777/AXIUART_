# AXIUART Bus Protocol Specification

## 1. Scope and Audience
- Defines the byte-oriented protocol used between the host UART driver and the AXIUART bridge.
- Applies to firmware, verification UVM sequences, and diagnostics tooling that generate or consume UART traffic for the bridge.
- Complements RTL documentation in `rtl/Frame_Parser.sv`, `rtl/Frame_Builder.sv`, and `rtl/Uart_Axi4_Bridge.sv`.

## 2. Physical Transport
- Transport is standard asynchronous UART (8 data bits, no parity, 1 stop bit).
- Default configuration in silicon and simulation uses 9600 baud; the design supports alternative baud rates via `uart_configure_baud_sequence`.
- UART shifts each byte least-significant bit first; multi-byte fields in this specification follow little-endian ordering on the wire.

## 3. Host → Device Command Frames
Command frames originate from the host. The parser accepts only the format below.

| Field | Width (bytes) | Encoding |
| --- | --- | --- |
| SOF | 1 | Fixed `0xA5`.
| CMD | 1 | Packed control bits, see Section 3.1.
| ADDR | 4 | Target AXI4-Lite address, little-endian (LSB transmitted first).
| DATA | 0–64 | Present only for write commands; length derived from CMD fields (Section 3.2).
| CRC | 1 | CRC-8 (polynomial `0x07`), computed over CMD, ADDR, and DATA.

### 3.1 Command Byte Layout
`CMD[7:0] = {RW, INC, SIZE[1:0], LEN[3:0]}`

| Bits | Name | Meaning |
| --- | --- | --- |
| 7 | `RW` | `0` = write, `1` = read.
| 6 | `INC` | `0` = fixed address, `1` = auto-increment address by beat size after each transfer.
| 5:4 | `SIZE` | `00` = 8-bit, `01` = 16-bit, `10` = 32-bit, `11` = reserved (decoder flags as invalid).
| 3:0 | `LEN` | Encodes beat count minus one. Effective beats = `LEN + 1` (range 1–16).

### 3.2 Write Payload Sizing
For writes (`RW=0`), the payload width in bytes is `(LEN + 1) × beat_size`, where `beat_size` is 1/2/4 for 8/16/32-bit accesses. Payload bytes are transmitted little-endian; the first byte corresponds to the least-significant byte of the first beat.

## 4. Device → Host Response Frames
All device responses start with SOF `0x5A` and reuse CRC-8 across STATUS, CMD echo, and any appended address/data bytes. The device echoes the host command so software can correlate responses without relying on ordering.

### 4.1 Write Acknowledgement Frames
| Field | Width (bytes) | Encoding |
| --- | --- | --- |
| SOF | 1 | Fixed `0x5A`.
| STATUS | 1 | Result code (Section 5).
| CMD echo | 1 | Original CMD byte as received (no modification).
| CRC | 1 | CRC-8 over STATUS and CMD echo.

Write acknowledgements never include ADDR or DATA; the absence of payload is the distinguishing factor for `RW=0` commands.

### 4.2 Read Response Frames
| Field | Width (bytes) | Encoding |
| --- | --- | --- |
| SOF | 1 | Fixed `0x5A`.
| STATUS | 1 | Result code (Section 5).
| CMD echo | 1 | Original CMD byte.
| ADDR echo | 4 | Echo of the command address, little-endian.
| DATA | 0–64 | Returned payload. Present only when STATUS=`0x00`. Length equals `(LEN + 1) × beat_size`.
| CRC | 1 | CRC-8 over STATUS, CMD echo, ADDR echo, and DATA bytes.

For failing read transactions (e.g. CRC error, AXI fault), the bridge omits ADDR/DATA and transitions directly to the CRC byte after the CMD echo.

### 4.3 Timing Rules
- The bridge issues the response only after AXI completion (or internal validation failure). There is no speculative acknowledgement.
- The device does not send interim busy tokens on the UART; instead it returns STATUS `0x06` when an AXI timeout escalates to BUSY.
- Drivers must listen continuously; there is no explicit flow control on the UART pins.

## 5. Status Codes
Status values currently generated by the RTL are summarised below (references in parentheses):

| Code | Meaning | Source |
| --- | --- | --- |
| `0x00` | Success | Default outcome (`Frame_Parser`, `Axi4_Lite_Master`).
| `0x01` | CRC mismatch detected on host frame | `Frame_Parser` validation.
| `0x02` | Unsupported command (SIZE=`11`) | `Frame_Parser` validation.
| `0x03` | Address alignment violation | `Frame_Parser`, `Axi4_Lite_Master` alignment checks.
| `0x04` | AXI timeout | `Frame_Parser` timeout monitor, `Axi4_Lite_Master` timeout.
| `0x05` | AXI slave error (`SLVERR`/`DECERR`) | `Axi4_Lite_Master` read/write response handling.
| `0x06` | Bridge busy (AXI stalled past early threshold) | `Uart_Axi4_Bridge` busy injection.
| `0x07` | Length field outside supported range | `Frame_Parser` validation.

Firmware should treat unknown status codes as fatal and log the raw byte for diagnostics.

## 6. Transaction Flow Requirements
1. Host transmits a command frame and waits for the response that starts with `0x5A`.
2. Drivers must parse the entire response, verify CRC, and check STATUS before queueing the next command.
3. For writes, the ACK frame contains no payload; software should not expect register data.
4. For reads, the driver must be prepared to receive up to 64 payload bytes and reconstruct 16 × 32-bit beats when `LEN=0xF` and `SIZE=0b10`.
5. When STATUS is non-zero, drivers should halt the sequence (no automatic retries are generated by the bridge) and log the failure reason.

## 7. CRC Definition
- Polynomial: `x^8 + x^2 + x + 1` (`0x07`).
- Initial value: `0x00`.
- Input and output are not reflected; there is no final XOR.
- Host frames: CRC covers CMD, ADDR, and DATA bytes in that order.
- Device frames: CRC covers STATUS, CMD echo, ADDR echo (if present), and DATA bytes.

## 8. Auto-Increment Semantics
- When `INC=1`, the bridge increments the current AXI address by the beat size after each beat.
- Multi-beat transfers honour LEN both for readback length and for transmit payload expectations; exceeding 64 total data bytes is flagged internally.
- When `INC=0`, every beat reuses the original address. Writes with multiple beats and `INC=0` overwrite the same location repeatedly.

## 9. Driver Software Expectations
- Accept and decode write acknowledgements; do not discard frames that lack payload.
- Enforce a watchdog on response arrival if the surrounding system requires stricter timing than the AXI timeout.
- Validate CRC on every response before acting on STATUS or DATA; retry logic belongs in software.
- Log both STATUS and CMD echo when raising errors to simplify post-mortem correlation with the originating transaction.

## 10. References
- RTL: `rtl/Frame_Parser.sv`, `rtl/Frame_Builder.sv`, `rtl/Uart_Axi4_Bridge.sv`, `rtl/Axi4_Lite_Master.sv`.
- Verification environment: `sim/uvm/agents/uart/uart_driver.sv`, `sim/uvm/env/uart_axi4_scoreboard.sv`.
- Host utilities: `software/basic_uart_test.py`, `software/debug_write_flow.py`.
